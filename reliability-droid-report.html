<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bitcoin Blocks – Reliability Improvements Report</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.5; padding: 24px; color: #e5e7eb; background: #0b0f17; }
    h1, h2 { color: #fff; }
    code, pre { background: #111827; color: #93c5fd; padding: 2px 6px; border-radius: 4px; }
    .card { border: 1px solid #374151; border-radius: 12px; padding: 16px; margin: 12px 0; background: #0f1623; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 9999px; border: 1px solid #374151; margin-right: 6px; font-size: 12px; }
    .ok { color: #34d399; border-color: #065f46; background: #06291c; }
    .warn { color: #f59e0b; border-color: #78350f; background: #2b1904; }
    .note { color: #60a5fa; border-color: #1e40af; background: #0b1a38; }
    ul { margin: 6px 0 0 18px; }
    li { margin: 4px 0; }
    a { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>Reliability Improvements – Summary</h1>
  <div class="card">
    <div class="tag ok">Status: Applied</div>
    <div class="tag note">Module: SpacetimeDB</div>
    <div class="tag note">Client: Next.js</div>
  </div>

  <h2>1) Connection & Subscription Reliability</h2>
  <div class="card">
    <ul>
      <li>Added <code>onConnect</code>/<code>onDisconnect</code> callbacks to Spacetime client (<code>src/lib/spacetime-client.ts</code>).</li>
      <li>Game context now uses explicit <code>subscriptionBuilder().subscribeAllTables()</code> and cleans up all table listeners on unmount (<code>src/AuthContext/GameContext.tsx</code>).</li>
      <li>Initial snapshot triggers (<code>getActiveRound</code>, <code>getPrizeConfig</code>) to hydrate caches after connect.</li>
      <li>Removed client auto-close timer; server <code>tick_rounds</code> is the source of truth.</li>
    </ul>
  </div>

  <h2>2) Server-Side Guards & Idempotency</h2>
  <div class="card">
    <ul>
      <li><code>create_round</code>: closes any existing <code>open</code> rounds to enforce single-open invariant and logs the action.</li>
      <li><code>submit_guess</code>: validates round is open and not expired; enforces one-guess-per-FID per round.</li>
      <li><code>end_round_manually</code>: idempotent; no-op if already closed/finished; logs change state.</li>
      <li><code>save_prize_config</code>: normalizes currency to <code>$Seconds</code>.</li>
      <li>File: <code>spacetime-server/src/lib.rs</code> (rewritten with tables + reducers preserved).</li>
    </ul>
  </div>

  <h2>3) UX/Validation Updates</h2>
  <div class="card">
    <ul>
      <li><b>FID-only submissions</b>: Guessing requires Farcaster login. UI disables inputs and shows guidance (<code>src/components/GuessForm.tsx</code>).</li>
      <li><b>CurrentRound</b>: Removed hardcoded block fallback; shows <code>N/A</code> when data unavailable (<code>src/components/CurrentRound.tsx</code>).</li>
      <li><b>Admin Panel</b>: Server now enforces one-open-round; UI warns when a round is already open.</li>
    </ul>
  </div>

  <h2>4) Mempool API – Fallbacks</h2>
  <div class="card">
    <ul>
      <li>New endpoint: <code>/api/mempool?action=block-by-height&height=...</code> with retries and txids fallback (<code>src/app/api/mempool/route.ts</code>).</li>
      <li>Existing endpoints hardened with retry + timeout.</li>
    </ul>
  </div>

  <h2>5) How to Test</h2>
  <div class="card">
    <ul>
      <li>Start the app, ensure SpacetimeDB module is published and reachable.</li>
      <li>Create a round in Admin Panel; observe a warning if an open round exists; verify only one open round remains in DB.</li>
      <li>Submit a guess as Farcaster user; verify duplicate FID guesses are blocked client + server-side.</li>
      <li>Let the timer elapse; confirm server auto-closes via <code>tick_rounds</code> log.</li>
      <li>Call the new API: <code>/api/mempool?action=block-by-height&height=&lt;known height&gt;</code> and verify JSON response.</li>
    </ul>
  </div>

  <h2>6) Notes</h2>
  <div class="card">
    <ul>
      <li>All timestamps in SpacetimeDB are stored in seconds; UI converts to ms.</li>
      <li>Admin announcements are FID-gated in UI; wallet admins still have panel access per product intent.</li>
    </ul>
  </div>

</body>
</html>
